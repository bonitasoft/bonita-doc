<h1>4.4.11 Creating a REST API extension</h1>
<p>REST API extensions provide a solution for integration between forms/pages and third party systems (including Bonita BPM Engine). They can be used to query <a href="define-and-deploy-the-bdm.md">business data</a>, Bonita BPM Engine APIs, or an external information
system (such as a database, web service, LDAP directory...). They also help to keep a clean separation between the front-end (forms, pages, and interfaces visible to users) and the back-end (processes).</p>
<h2>Prerequisites</h2>
<p>Prerequisites for developing a REST API extension are:</p>
<ul>
<li>Java/Groovy development expertise.</li>
<li>Basic knowledge of Maven.</li>
<li><strong>Access to <a href="http://central.maven.org/maven2">Maven central repository</a></strong>. If your provider is restricting Internet access you may configure <a href="https://maven.apache.org/guides/mini/guide-proxies.md">proxy settings</a> or create a <a href="https://maven.apache.org/guides/mini/guide-mirror-settings.md">mirror repository</a>.</li>
</ul>
<h2>Example description</h2>
<p>The following sections show how to create a REST API extension. As an example, we create a REST API extension that use Bonita BPM Engine to provide user informations (first name, last name, email address).</p>
<h2>Generate a new REST API extension skeleton</h2>
<ol>
<li>In the <strong>Development</strong> menu, choose <strong>REST API Extension</strong> then <strong>New...</strong>.</li>
<li>Enter a <strong>Name</strong>, for example <em>User informations REST API Extension</em>.</li>
<li>Enter a <strong>Description</strong>, for example <em>Query Bonita BPM Engine to retrieve user informations</em>.</li>
<li>Enter a package name, use to set the artifact <strong>Group id</strong>, for example: <em>com.company.rest.api</em></li>
<li>Enter a <strong>Project name</strong>, for example <em>userInformationRestAPIExension</em></li>
<li>Click <strong>Next</strong>.</li>
<li>Enter the <strong>pathTemplate</strong> for this REST API extension, for example <em>userInformation</em>. This will be the access point of the API, and follows this pattern: <code>{bonita_portal_context}/API/extension/userInformation</code>.</li>
<li>As this REST API extension does not access business data you can safely uncheck &quot;Add BDM dependencies&quot; check box.</li>
<li>Define a <strong>Permission</strong> for the extension (replace the default one), for example <em>read_user_information</em>.</li>
<li>Click <strong>Next</strong></li>
<li>This screen defines <strong>URL parameters</strong> that will be passed to the API. By default, <em>p</em> and <em>c</em> parameters are defined to enables paged result, it applies well in our examples as we want to return a list of users.</li>
<li>Click <strong>Create</strong>.</li>
</ol>
<h2>Write the code</h2>
<h3>Main source code</h3>
<p>First step would be to remove files and code related to REST API configuration as we don't need to define configuration parameters for our REST API:</p>
<ol>
<li>Delete <code>configuration.properties</code> from <code>src/main/resources</code> folder</li>
<li>Delete <code>testConfiguration.properties</code> from <code>src/test/resources</code></li>
<li>Remove the setup of configuration file mock. Edit <code>IndexTest.groovy</code>, go to <code>setup()</code> method and remove the line starting with <code>resourceProvider...</code>.</li>
<li>Remove the example of configuration usage in <code>Index.groovy</code> file (see comment starting with: &quot;Here is an example of you can...&quot;).</li>
</ol>
<p>Now we can add our business logic. In <code>Index.groovy</code>, in <code>doHandle</code> method, locate the &quot;Your code goes here&quot; comment and add your code below (removing the existing <code>result</code> and <code>return</code> statement):</p>
<pre><code class="language-groovy">// Convert parameters from string to int
p = p as int
c = c as int

// Initialize the list to store users information  
def usersInformation = []

// Get the list of user  
List&amp;lt;User&amp;gt; users = context.apiClient.identityAPI.getUsers(p*c, c, UserCriterion.FIRST_NAME_ASC)

// Iterate over each user
for (user in users) {
	// Get user extra information (including email address)
	ContactData contactData = context.apiClient.identityAPI.getUserContactData(user.id, false)

	// Create a map with current user first name, last name and email address
	def userInformation = [firstName: user.firstName, lastName: user.lastName, email: contactData.email]

	// Add current user information to the global list
	usersInformation &lt;&lt; userInformation
}

// Prepare the result
def result = [p: p, c: c, userInformation: usersInformation]

int startIndex = p*c
int endIndex = p*c + users.size() - 1

// Send the result as a JSON representation
return buildPagedResponse(responseBuilder, new JsonBuilder(result).toPrettyString(), startIndex, endIndex, context.apiClient.identityAPI.numberOfUsers)
</code></pre>
<p>Make sure you are adding all missing imports (ctrl+alt+o).</p>
<h3>Test source code</h3>
<p>Now we need to update the test to verify the behavior of our REST API extension by editing <code>IndexTest.groovy</code>.</p>
<p>First step is to define some mocks for our externals dependencies such as Engine Identity API. Add the following mocks declaration after the existing ones:
<code>def apiClient = Mock(APIClient) def identityAPI = Mock(IdentityAPI) def april = Mock(User) def william = Mock(User) def walter = Mock(User) def contactData = Mock(ContactData)</code></p>
<p>Now we need to define the generic behavior of our mocks. <code>setup()</code> method should have the following content:
`context.apiClient &gt;&gt; apiClient
apiClient.identityAPI &gt;&gt; identityAPI</p>
<p>identityAPI.getUsers(0, 2, _) &gt;&gt; [april, william]
identityAPI.getUsers(1, 2, _) &gt;&gt; [william, walter]
identityAPI.getUsers(2, 2, _) &gt;&gt; [walter]</p>
<p>april.firstName &gt;&gt; &quot;April&quot;
april.lastName &gt;&gt; &quot;Sanchez&quot;
william.firstName &gt;&gt; &quot;William&quot;
william.lastName &gt;&gt; &quot;Jobs&quot;
walter.firstName &gt;&gt; &quot;Walter&quot;
walter.lastName &gt;&gt; &quot;Bates&quot;</p>
<p>identityAPI.getUserContactData(*_) &gt;&gt; contactData
contactData.email &gt;&gt; &quot;test@email&quot;`</p>
<p>Now you can define a test method. Replace existing test <code>should_return_a_json_representation_as_result</code> method with the following one:
`def should_return_a_json_representation_as_result() {
given: &quot;a RestAPIController&quot;
def index = new Index()
// Simulate a request with a value for each parameter
httpRequest.getParameter(&quot;p&quot;) &gt;&gt; &quot;0&quot;
httpRequest.getParameter(&quot;c&quot;) &gt;&gt; &quot;2&quot;</p>
<p>when: &quot;Invoking the REST API&quot;
def apiResponse = index.doHandle(httpRequest, new RestApiResponseBuilder(), context)</p>
<p>then: &quot;A JSON representation is returned in response body&quot;
def jsonResponse = new JsonSlurper().parseText(apiResponse.response)
// Validate returned response
apiResponse.httpStatus == 200
jsonResponse.p == 0
jsonResponse.c == 2
jsonResponse.userInformation.equals([
[firstName:&quot;April&quot;, lastName: &quot;Sanchez&quot;, email: &quot;test@email&quot;],
[firstName:&quot;William&quot;, lastName: &quot;Jobs&quot;, email: &quot;test@email&quot;]
]);
}`</p>
<p>You should now be able to run your unit test. Right click the <code>IndexTest.groovy</code> file and click on <strong>REST API Extension</strong> &gt; <strong>Run JUnit Test</strong>. The JUnit view displays the test results. All tests should pass.</p>
<h2>Build, deploy and test the REST API extension</h2>
<p>Studio let you build and deploy the REST API extension in the embedded test environment.</p>
<p>First step is to configure security mapping for your extension in Studio embedded test environment:</p>
<ol>
<li>In the <strong>Development</strong> menu, choose <strong>REST API Extension</strong> then <strong>Edit permissions mapping</strong>.</li>
<li>Append this line at the end of the file:
<code>profile|User=[read_user_information]</code> This means that anyone logged in with the user profile is granted this permission.</li>
<li>Save and close the file.</li>
</ol>
<p>Now you can actually build and deploy the extension:</p>
<ol>
<li>In the <strong>Development</strong> menu, choose <strong>REST API Extension</strong> &gt; <strong>Deploy...</strong></li>
<li>Select the userInformationRestAPIExension REST API extension.</li>
<li>Click on Deploy button.</li>
<li>In the coolbar, click the Portal icon. This opens the Bonita BPM Portal in your browser.</li>
<li>In the Portal, change to the <strong>Administrator</strong> profile.</li>
<li>Go to the <strong>Resources</strong> tab, and check that the User information REST API extension is in the list of REST API extension resources.</li>
</ol>
<p>Now you finally test your REST API extension:</p>
<ol>
<li>Open a new tab in the web browser</li>
<li>Enter the following URL: <code>http://localhost:8080/bonita/API/extension/userInformation?p=0&amp;c=10</code>.</li>
<li>The JSON response body should be displayed.</li>
</ol>
<p>The LDAP REST API extension can be used in forms and pages in the <strong>UI Designer</strong> using an <code>External API</code> variable.</p>
