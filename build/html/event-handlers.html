<h1>Event handlers</h1>
<p>An event handler is an extension to the engine that is configured to run when a specified event occurs.
You can add event handlers for several purposes and you can configure which events you want to catch.
We strongly recommend that you add only appropriate handlers and carefully code the handler filters to handle only those events that you are interested in.</p>
<p>An event is a change to any object in the database (user, activity, processDefinition,... ).
You can create an event handler to track any change to any object in the database and take the appropriate action. For example:</p>
<ul>
<li>Catch PROCESSINSTANCE_CREATED to detect that a process instance has started, and notify the process supervisor.</li>
<li>Catch FLOWNODE_INSTANCE_CREATED to detect that a human task is available, and send email to all the users elligible to perform it.</li>
<li>Catch HIDDEN_TASK_CREATED to detect that a service task becomes available, and start an external system that is required to complete the task.</li>
</ul>
<p>At the end of this page there is a list of all the events.</p>
<h2>Example: deploy an event handler</h2>
<p>This example shows an event handler that detects changes in the state of activity instances. When executing, the event handler calls <a href="technical-logging.md">technical logger service</a>.</p>
<h3>create a maven project for event handler jar</h3>
<p>pom.xml :</p>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;
        xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
        xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;groupId&gt;org.bonitasoft.example&lt;/groupId&gt;
    &lt;artifactId&gt;eventHandlerExample&lt;/artifactId&gt;
    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;properties&gt;
        &lt;bonita.version&gt;7.2.0&lt;/bonita.version&gt;
        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
    &lt;/properties&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.bonitasoft.engine&lt;/groupId&gt;
            &lt;artifactId&gt;bonita-server&lt;/artifactId&gt;
            &lt;version&gt;${bonita.version}&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
                &lt;configuration&gt;
                    &lt;source&gt;1.7&lt;/source&gt;
                    &lt;target&gt;1.7&lt;/target&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;

&lt;/project&gt;
</code></pre>
<h3>Create event handler class:</h3>
<p>Create a class that implements <code>SHandler&lt;SEvent&gt;</code>.</p>
<p>src/main/java/org/bonitasoft/example/EventHandlerExample.java:</p>
<pre><code class="language-java">package org.bonitasoft.example;

import java.util.UUID;

import org.bonitasoft.engine.events.model.SEvent;
import org.bonitasoft.engine.events.model.SHandler;
import org.bonitasoft.engine.events.model.SHandlerExecutionException;
import org.bonitasoft.engine.log.technical.TechnicalLogSeverity;
import org.bonitasoft.engine.log.technical.TechnicalLoggerService;

public class EventHandlerExample implements SHandler&lt;SEvent&gt; {

    private final TechnicalLoggerService technicalLoggerService;
    private TechnicalLogSeverity technicalLogSeverity;

    public EventHandlerExample(TechnicalLoggerService technicalLoggerService) {
        this.technicalLoggerService = technicalLoggerService;

        //set desired logging level
        this.technicalLogSeverity = TechnicalLogSeverity.INFO;
    }

    public void execute(SEvent event) throws SHandlerExecutionException {
        if (technicalLoggerService.isLoggable(this.getClass(), technicalLogSeverity)) {
        technicalLoggerService.log(this.getClass(), technicalLogSeverity, &quot;ExampleHandler: executing event &quot; + event.getType());
        }

        // add your business logic here

    }

    public boolean isInterested(SEvent event) {
        if (technicalLoggerService.isLoggable(this.getClass(), technicalLogSeverity)) {
            technicalLoggerService.log(this.getClass(), technicalLogSeverity,
            &quot;ExampleHandler - event &quot;
            + event.getType()
            + &quot; - asks if we are interested in handling this event instance&quot;;

        }

        // add your business logic here
        // for this example purpose, assume we are always interested
        return true;
    }

     public String getIdentifier() {
        //ensure this handler is registered only once
        return UUID.randomUUID().toString();
    }
}
</code></pre>
<h3>Deploy jar</h3>
<ul>
<li>Build eventHandlerExample-1.0-SNAPSHOT.jar using <code>mvn clean install</code> maven command.</li>
<li>Copy eventHandlerExample-1.0-SNAPSHOT.jar in webapps/bonita/WEB-INF/lib/ folder (for tomcat bundle)</li>
</ul>
<h3>Register an event handler</h3>
<p>An event handler is registered on an event by adding an entry to the appropriate map. The list of handlers registered can be extended in the BONITA_HOME engine-server/conf/tenants/TENANT_ID/bonita-tenant-sp-custom.xml:</p>
<pre><code class="language-xml">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:p=&quot;http://www.springframework.org/schema/p&quot;
      xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd&quot;&gt;

    &lt;!-- add event handler bean definition --&gt;
    &lt;bean id=&quot;myEventHandlerExample&quot; class=&quot;org.bonitasoft.example.EventHandlerExample&quot;&gt;
        &lt;!-- add logging service --&gt;
        &lt;constructor-arg name=&quot;technicalLoggerService&quot; ref=&quot;tenantTechnicalLoggerService&quot; /&gt;
    &lt;/bean&gt;

    &lt;bean id=&quot;eventHandlers&quot; class=&quot;org.springframework.beans.factory.config.MapFactoryBean&quot;&gt;
        &lt;property name=&quot;targetMapClass&quot;&gt;
            &lt;value&gt;java.util.HashMap&lt;/value&gt;
        &lt;/property&gt;
        &lt;property name=&quot;sourceMap&quot;&gt;
            &lt;map&gt;
                &lt;entry key=&quot;PROCESSINSTANCE_STATE_UPDATED&quot; value-ref=&quot;myEventHandlerExample&quot;/&gt;
            &lt;/map&gt;
        &lt;/property&gt;
    &lt;/bean&gt;

&lt;/beans&gt;
</code></pre>
<h3>Test it</h3>
<p>Restart web server and run a basic process and check bonita log file in folder tomcat/logs:</p>
<pre><code>INFOS: THREAD_ID=78 | HOSTNAME=gt | ExampleHandler: event PROCESSINSTANCE_STATE_UPDATED - asks if we are interested in handling this event instance
...
INFOS: THREAD_ID=78 | HOSTNAME=gt | ExampleHandler: executing event PROCESSINSTANCE_STATE_UPDATED
</code></pre>
<h2>Filter an event</h2>
<p>An event handler contains a filter, <code>isInterested</code>, which detects the relevant instances of the event.
The example below shows how to use the State Id of a flow node to filter for a particular state (in this case, failed).
Flownode State Ids are defined in the subclasses of <code>org.bonitasoft.engine.core.process.instance.api.states.FlowNodeState</code>.
There is no exhaustive list; the set of states is extensible without notice.</p>
<pre><code class="language-groovy">public boolean isInterested(SEvent event) {
    boolean isInterested = false;

    // Get the object associated with the event
    Object eventObject = event.getObject();

    // Check that event is related to a task
    if (eventObject instanceof SFlowNodeInstance) {
        SFlowNodeInstance flowNodeInstance = (SFlowNodeInstance) eventObject;

        // Verify that state of the task is failed. See
        // FailedActivityStateImpl
        isInterested = (flowNodeInstance.getStateId() == 3);
    }

    return isInterested;
}
</code></pre>
<p>Event handlers are recursive, that is, if an event handler itself modifies something and triggers an event, the relevant event handler is called. This means you might need to include loop detection in your event handler.</p>
<h2>Event list</h2>
<p>This is a snapshot of the events used in the Engine.</p>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Service</td>
<td style="text-align:left">Events</td>
</tr>
<tr>
<td style="text-align:left">ActivityInstanceServiceImpl</td>
<td style="text-align:left">ACTIVITYINSTANCE_CREATED, HUMAN_TASK_INSTANCE_ASSIGNEE_UPDATED, ACTIVITYINSTANCE_STATE_UPDATED, ACTIVITY_INSTANCE_TOKEN_COUNT_UPDATED, HIDDEN_TASK_CREATED, HIDDEN_TASK_DELETED, PENDINGACTIVITYMAPPING_CREATED, PENDINGACTIVITYMAPPING_DELETED</td>
</tr>
<tr>
<td style="text-align:left">ActorMappingServiceImpl</td>
<td style="text-align:left">ACTOR_CREATED, ACTOR_DELETED, ACTOR_UPDATED, ACTOR_MEMBER_CREATED, ACTOR_MEMBER_DELETED</td>
</tr>
<tr>
<td style="text-align:left">CategoryServiceImpl</td>
<td style="text-align:left">CATEGORY_CREATED, CATEGORY_DELETED, CATEGORY_UPDATED</td>
</tr>
<tr>
<td style="text-align:left">CommandServiceImpl</td>
<td style="text-align:left">COMMAND_CREATED, COMMAND_DELETED, COMMAND_UPDATED</td>
</tr>
<tr>
<td style="text-align:left">SCommentServiceImpl</td>
<td style="text-align:left">COMMENT_CREATED, COMMENT_DELETED</td>
</tr>
<tr>
<td style="text-align:left">ConnectorInstanceServiceImpl</td>
<td style="text-align:left">CONNECTOR_INSTANCE_CREATED, CONNECTOR_INSTANCE_DELETED, CONNECTOR_INSTANCE_STATE_UPDATED, CONNECTOR_INSTANCE_UPDATED</td>
</tr>
<tr>
<td style="text-align:left">DependencyServiceImpl</td>
<td style="text-align:left">DEPENDENCY_CREATED, DEPENDENCYMAPPING_CREATED, DEPENDENCY_DELETED, DEPENDENCYMAPPING_DELETED, DEPENDENCY_UPDATED, DEPENDENCYMAPPING_UPDATED</td>
</tr>
<tr>
<td style="text-align:left">DocumentMappingServiceImpl</td>
<td style="text-align:left">DOCUMENTMAPPING_CREATED, DOCUMENTMAPPING_DELETED, DOCUMENTMAPPING_UPDATED</td>
</tr>
<tr>
<td style="text-align:left">SEventInstanceServiceImpl</td>
<td style="text-align:left">EVENT_INSTANCE_CREATED, EVENT_TRIGGER_INSTANCE_CREATED, EVENT_TRIGGER_INSTANCE_DELETED, MESSAGE_INSTANCE_CREATED, MESSAGE_INSTANCE_DELETED, MESSAGE_INSTANCE_UPDATED</td>
</tr>
<tr>
<td style="text-align:left">ExternalIdentityMappingServiceImpl</td>
<td style="text-align:left">EXTERNAL_IDENTITY_MAPPING_CREATED, EXTERNAL_IDENTITY_MAPPING_DELETED</td>
</tr>
<tr>
<td style="text-align:left">FlowNodeInstanceServiceImpl</td>
<td style="text-align:left">ARCHIVED_FLOWNODE_INSTANCE_DELETED, FLOWNODE_INSTANCE_DELETED</td>
</tr>
<tr>
<td style="text-align:left">GatewayInstanceServiceImpl</td>
<td style="text-align:left">GATEWAYINSTANCE_CREATED, GATEWAYINSTANCE_HITBYS_UPDATED, GATEWAYINSTANCE_STATE_UPDATED</td>
</tr>
<tr>
<td style="text-align:left">IdentityServiceImpl</td>
<td style="text-align:left">GROUP_CREATED, GROUP_DELETED, GROUP_UPDATED, METADATA_CREATED, METADATA_DELETED, METADATA_UPDATED, METADATAVALUE_CREATED, METADATAVALUE_DELETED, METADATAVALUE_UPDATED, ROLE_UPDATED, ROLE_CREATED, ROLE_DELETED, USER_UPDATED, USER_CREATED, USER_DELETED, USER_CONTACT_INFO_UPDATED, USER_CONTACT_INFO_CREATED, USER_CONTACT_INFO_DELETED, USERMEMBERSHIP_UPDATED, USERMEMBERSHIP_CREATED, USERMEMBERSHIP_DELETED</td>
</tr>
<tr>
<td style="text-align:left">JobServiceImpl</td>
<td style="text-align:left">eventType_CREATED, eventType_DELETED</td>
</tr>
<tr>
<td style="text-align:left">JobWrapper</td>
<td style="text-align:left">JOB_COMPLETED, JOB_EXECUTING</td>
</tr>
<tr>
<td style="text-align:left">ProcessDefinitionServiceImpl</td>
<td style="text-align:left">PROCESSDEFINITION_CREATED, PROCESSDEFINITION_DELETED, PROCESSDEFINITION_DEPLOY_INFO_UPDATED, PROCESSDEFINITION_IS_DISABLED_UPDATED, PROCESSDEFINITION_IS_ENABLED_UPDATED, PROCESSDEFINITION_IS_RESOLVED_UPDATED</td>
</tr>
<tr>
<td style="text-align:left">ProcessInstanceServiceImpl</td>
<td style="text-align:left">MIGRATION_PLAN_UPDATED, PROCESS_INSTANCE_CATEGORY_STATE_UPDATED, PROCESSINSTANCE_CREATED, PROCESSINSTANCE_DELETED, PROCESSINSTANCE_STATE_UPDATED, PROCESSINSTANCE_UPDATED</td>
</tr>
<tr>
<td style="text-align:left">ProfileServiceImpl</td>
<td style="text-align:left">PROFILE_CREATED, PROFILE_DELETED, PROFILE_UPDATED, ENTRY_PROFILE_CREATED, ENTRY_PROFILE_DELETED, ENTRY_PROFILE_UPDATED, PROFILE_MEMBER_DELETED</td>
</tr>
<tr>
<td style="text-align:left">ReportingServiceImpl</td>
<td style="text-align:left">REPORT_CREATED, REPORT_DELETED</td>
</tr>
<tr>
<td style="text-align:left">SupervisorMappingServiceImpl</td>
<td style="text-align:left">SUPERVISOR_CREATED, SUPERVISOR_DELETED</td>
</tr>
<tr>
<td style="text-align:left">ThemeServiceImpl</td>
<td style="text-align:left">THEME_CREATED, THEME_DELETED, THEME_UPDATED</td>
</tr>
<tr>
<td style="text-align:left">TokenServiceImpl</td>
<td style="text-align:left">PROCESS_INSTANCE_TOKEN_COUNT_CREATED, PROCESS_INSTANCE_TOKEN_COUNT_DELETED</td>
</tr>
</tbody>
</table>
