= Connectors execution
:description: == What are connectors

== What are connectors

Connectors are extension points that can be added to a process to extend Bonita Runtime capabilities. They are a piece of code having inputs defined as `Expressions` and outputs defined as `Operations`.

== Execution mechanism

=== Diagram of the execution

Connectors execution are triggered by a `Work` and are executed in their own thread pool.

image::images/connector_execution.png[Connector execution]

=== Connector timeout

[NOTE]
====

For Enterprise, Performance, Efficiency, and Teamwork editions only.
====

A timeout can be configured to cancel the connector execution if it takes more than a certain amount of time.

The timeout will try to interrupt the thread executing the connector.
If the code executing in the thread cannot be interrupted, the thread will not stop.
In practice, it means that in this case, the connector will timeout, releasing the execution of the task that called it, but the connector executor will still try to finish executing the connector's code, and will not be available to execute another connector.
A typical example of this is if the custom code in a groovy connector falls into an infinite loop : the connector will timeout, but the connector executor will be running forever.

image::images/connector_execution_timeout.png[Connector execution with timeout]

== Configuration

The size of the pool to execute connector and the timeout can be configured as described in xref:performance-tuning.adoc#connector_service[Connector service performance tuning page]

== Work service mechanism

image::images/images-6_0/user_task_details.png[Diagram of the details of user task execution]

. Bonita Engine commits the transaction and then submits a work to execute the connectors asynchronously. The connectors are executed outside any transaction and thus are not a problem for the data integrity if the execution takes too long
. As soon as there is a free slot in the Work Service, it executes the work, which is in fact the connector execution
. When a connector execution is finished, if there are other connectors, they are executed in the same way. If there are no more connectors, Bonita Engine continues to execute the state's behavior by triggering a new work
. When the engine executes a state's behavior, it updates the display name, and then sets the activity to the state _Ready_. As this is a stable state, the engine commits the transaction and stops
. The state *READY* will then be executed through an API call

== Connector cost in terms of transactions

If there is a connector to execute in the state's behavior, then the transaction is committed and the connector is executed outside of any transaction. +
The flow node stays in the current state while the connector is being executed. +
When the execution of the last connector is complete, the state's behaviour is completed. If you are using a Bonita Subscription edition, a timeout limit can be set for connector execution.

=== Example: User task

The diagrams below show the transactions and states when a user task is executed. +
The vertical line represents the condition necessary to execute the current state. +
The first state is _initializing_: it is automatically executed and the flow node goes to next state (*READY*) but is executed only after an API call.

*In the first diagram, the task contains connectors*

image::images/images-6_0/user_task_execution_with_connector.png[Diagram of the states and transactions when a user task with connectors is executed]

*In the second diagram, there are no connectors in the task*

image::images/images-6_0/user_task_execution_without_connector.png[Diagram of the states and transactions when a user task with connectors is executed]

As you can see in these illustrations, there is a non-negligible cost when adding some connectors on an activity: +

* If there is no connector to execute, then the state executes in one transaction +
* If there is at least one connector to execute in the state, the state execution requires at least three transactions:

 ** The first transaction is committed just before the execution of the connectors. There is one transaction for this, whatever the number of connectors
 ** The connectors are not transactional. Nevertheless, a transaction is needed to save the output data of the connector execution. There will be a transaction for each connector that is executed
 ** The last transaction is used to continue to execute the current state's behavior, and to set the state to the next reachable one (but not execute it)

If the connector execution never ends because the external system does not have a timeout, the connector instance is re-executed at next server startup
(or automatically by the recovery mechanism, if your Bonita Platform is Bonita 2021.1 or greater).
