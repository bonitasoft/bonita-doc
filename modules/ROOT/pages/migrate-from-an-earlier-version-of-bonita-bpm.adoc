= Updating Bonita Runtime with Migration Tool 
:description: This page explains how to update Bonita Runtime main version (single or multiple nodes) using Bonita Migration Tool.

Service stopped: Migrate the data, install a new environment, test non-migrated elements behavior and compatibility with new bonita version

[NOTE]
====

.*Updating* means moving from one Bonita version to a newer one, to benefit from:
* new features (in Main versions)
* technology updates (in Main versions)
* bug fixes (in Maintenance versions)
 
====

== Overview

This page explains how to update your Bonita Runtime to a newer version.
Short procedure : Service stopped, migrate the data, install a new environment, test non-migrated elements behavior and compatibility with new bonita version. 
// add link to the paragraph below 
Detailed procedure : Updating Bonita bundle: step-by-step procedure. 

There are 2 versions of Bonita Migration tool: 
|===
|*Tool* | *Use cases*
| Bonita Migration Tool 1.x |From version *6.0.2* or later to any version up to *7.0.0*
| Bonita Migration Tool 2.x |From version *7.0.0* or later to any version up to *7.13.0*
|===

____
WARNING : If you consider updating from Bonita 6.5.3 to Bonita 7.1.0, you must first update from Bonita 6.5.3 to Bonita 7.0.0 using Bonita Migration Tool 1.x, and then update from Bonita 7.0.0 to Bonita 7.1.0 using Bonita Migration Tool 2.x.

You are *NOT* recommended to start Bonita 7.0.0 after you update to it, but to continue with the second phase of the update process.
____

== How does Bonita Migration Tool work?

_Bonita Migration Tool_ contains a set of scripts that execute changes on the data for making it compatible with a newer version of Bonita Runtime. 
The tool is provided as a zip archive that contains an executable script to determine your current version and to request the targeted main Bonita version for the update.
The update process is step-based, with each maintenance version being equal to a step. The script manages the sequence of steps from your current version to the targeted version. After each main or maintenance version update

=== Can the Migration Tool be used for upgrade/downgrade between community and subscription?
The answer is *“NO”*. 
The Bonita Migration Tool does not help you upgrade/downgrade between the community/subscription versions, so you cannot xref:upgrade-from-community-to-a-subscription-edition.adoc[change edition] at the same time as updating.

=== Bonita version to target

Always update to the latest maintenance release version of the chosen main release. Maintenance releases often contain bug fixes made shortly after the release of subsequent main releases.
____
*For example:* Bonita 7.13.2 contains fixes for certain bugs that were found earlier in the 7.13.x versions (like 7.13.0 and 7.13.1). To get all of those fixes, update to the 7.13.2 maintenance version instead of 7.13.1.
____

=== Download
// add links to Bonita web site and Customer Service center => OK
Download the target Bonita version bundle and the adequate update tool for your Edition from the http://www.bonitasoft.com/downloads[Bonitasoft web site] for Bonita Community edition or from the https://customer.bonitasoft.com/download/request[Customer Service Center] for Bonita Subscription editions. You will also have to download a Tomcat server that matches the target Bonita Runtime version. 

=== Licenses
If you are running a Bonita Subscription edition, you need a valid license for your Bonita target version. 
If you are updating to a new maintenance version within the same main version, your license remains valid after the update. 

== Things to know before launching the update

[CAUTION]
====
.*Special attention required on:*
* Do not pause the BPM Services before the update. Several bugs affect legacy Bonita versions by preventing a smooth Bonita Runtime update with BPM services paused when:
** The source version is older than Bonita 7.8.0, and the target version is between Bonita 7.8.0 and Bonita 7.11.5
** The source version is older than Bonita 7.10.5 and the target version is older than Bonita 2021.1
* Deployed process definitions: The processes will continue to run using the definition created in the previous Bonita version. 
====

.Before launching the update script, there are *manual activities* to be done, like: 
* Go through the release notes of all the versions till the one targeted for the update, for changes/deprecations/removals and see if they impact your existing developments.
____
*For example:* when updating from 7.9.y to 7.10.0, you will need to read all the release notes in between those versions.
____

// link to special cases and troubleshouting to be added => 
* Go through the [Special cases] and [Troubleshooting] paragraphs below.

* Runtime custom configuration. You will need to re-apply the customizations after the update process finishes. *If the target version of the update is Bonita 7.3 or greater, you can use xref:runtime:bonita-platform-setup.adoc[the setup tool] to push the configuration files.*

* Process definition sources (.bos files) require a manual update. First export then import them into the new Bonita Studio version.
* Custom connectors, actor filers, data types, custom pages, RestAPI extensions: will for sure continue to work in the new version if no custom code has been added to the default Bonita code. If you did add custom code, before starting the update, check in the release notes for any breaking changes and test them thoroughly after the update.
* Check that the database version is up-to-date and supported by the new Bonita version.
* Secure the update by doing backups. Better safe than sorry.

.Following elements will be updated *automatically* when launching the update script:
* Engine server
* Engine database (including all data on active and archived process instances) 
* Organization definition
* Log files from the previous versions will not be touched. A new dedicated folder for the target version will be created to store the log files. 
* Runtime data (in the database after Bonita Runtime 7.3)
* Configuration files (in the database after Bonita Runtime 7.3) will be replaced with the default configuration files of the new version

When the script has finished executing, you will have to complete the update procedure by unzipping and configuring new version’s bundle.

// add link to the paragraph => 
Go through the paragraph [Updating Bonita bundle: step-by-step procedure] for step-by-step instructions.

=== BACKUPS 
==== Configuration files 
As mentioned above, during the update, Bonita configuration files will be reseted to the default version so that new settings could be applied (from the $BONITA_HOME folder before Bonita 7.3.0 or inside the database starting from Bonita 7.3.0 version). 

Therefore, having a backup of your configuration files before launching the updating procedure is *HIGHLY* necessary, so you could merge custom properties and configurations to the target Bonita Runtime.

.Starting with Bonita 7.3.Y, there is no more bonita home folder, which means that: 
// link to setup tool 
* if your current installation *DOES* have customized the configuration files, you will have to use xref:runtime:bonita-platform-setup.adoc[the setup tool] to push your customized configuration files to the database where the configuration is stored. 
* if your current installation *DOES NOT* have customized configuration files, then you do not need to configure the bundle any further. 

==== Database files 
From database point of view, as any operation on a productive system, an update is not a zero-risk operation.
*Therefore, it is necessary to backup your database before launching the updating procedure.*


=== JRE requirements

Based on your target Bonita version, check whether JRE update is required in your environment before launching the update process:  

|===
|*JRE version* |*Bonita version*
|JRE version 7
|If targeting an update from Bonita 7.0 to 7.4.x
|JRE version 8
|If targeting an update from Bonita 7.5 to Bonita 2021.1-0811
|JRE version 11
|If targeting an update from Bonita 2021.2 or greater
|===

For more info, see Support Guide and Supported Environment Matrix for Server.

[#rdbms_requirements]

[WARNING]
====

*RDBMS requirements:*
The version targeted may not support the version of the database that is being migrated. You may then need to upgrade the version of your database prior to running the Bonita Migration Tool.

* Please check the xref:hardware-and-software-requirements.adoc[database requirements].
* If you need to upgrade your database:
 ** Please make sure to apply all the xref:database-configuration.adoc#specific_database_configuration[RDBMS customisations required by Bonita] when setting up the new version.
 ** Please make sure to use the xref:database-configuration.adoc#proprietary_jdbc_drivers[appropriate JDBC driver]
 ** WARNING: *Oracle database* requires to use the official driver for each specific version. Make sure your driver's checksum matches the Oracle official one for your xref:database-configuration.adoc#proprietary_jdbc_drivers[database version], see xref:#oracle12[Oracle] below. 
====

*Community/Subscription edition:*
The tool updates your platform (_bonita_home_ folder and the database). You cannot xref:upgrade-from-community-to-a-subscription-edition.adoc[change edition] while updating.

* If you are running a Bonita Subscription Pack edition, you need a valid license for your target version.
* If you are upgrading to a new maintenance version and not changing the minor version number (for example, you are updating from x.y.0 to x.y.1), your current license remains valid after update.

[NOTE]
====

Starting from version 7.3 there is no more _bonita home_ folder. This means that, if your installation does not have any custom change, then you do not need to configure the bundle any further for an installation updated in 7.3 or above.

On the other hand, if you have customized your configuration, you will have to use the xref:bonita-bpm-platform-setup.adoc#update_platform_conf[platform setup tool] to send your customized configuration files to the database where configuration is stored, for versions 7.3 and above.
====

image::images/images-6_0/migration_bigsteps.png[Update steps]

== How it works

The _Bonita Migration Tool_ contains a set of script that execute changes on the data to make it compatible with earlier version of Bonita Platform.
This tool is provided as a zip archive and contains an executable script that will determine your current configuration and ask you in which version you want to update.

The update process is step-wise by maintenance version and the script manages the sequence of steps from your current version to the target version.
After each minor or maintenance version upgrade, you have the option to pause or continue to the next step.

Following elements will be updated automatically when launching the update script:

* Engine server
* Engine database, including all data on active and archived process instances
* Organization definition
* Runtime data in Bonita Home, _until 7.3_
* Configuration files in Bonita Home, which are replaced with the default configuration files for the new version
* Log files from the previous version are not impacted by update

The following are not updated automatically:

* Configuration of the platform: Before 7.3 in the _Bonita Home_ folder and after 7.3 in database. Reapply your customizations manually after the update  script has finished (using xref:bonita-bpm-platform-setup.adoc#update_platform_conf[platform setup tool] if updated to 7.3.0+).
* Deployed process definitions: The processes will continue to run using the definition created in the previous version of Bonita.
* Process definition sources (`.bos` files): Update these by importing them into the new version of Bonita Studio.
* +++<a id="bdm_redeploy">++++++</a>+++Business data model, and the business data database: if the update path include version `7.0.0`,`7.2.0` or `7.2.4`, the Business data model must be redeployed after update. Only in that case, can you pause the tenant before update, as a tenant admin, so that you'll be able to redeploy the BDM on a paused tenant once update is done, using xref:define-and-deploy-the-bdm.adoc[Define and deploy the BDM]). Otherwise, no action is required.
* Custom connectors, actor filers, data types: These might continue to work in the new version, but should be tested, depending on your custom code.
* Custom pages: These might continue to work in the new version, but should be tested depending on your custom code.
* Custom reports: These might continue to work in the new version, but should be tested depending on your custom code.
* REST API Extensions: These might continue to work in the new version, but should be tested depending on your custom code.

When the script has finished,
you need to complete the update by unzipping and configuring a bundle for the new version.
See  <<update,Update your platform>> for step-by-step instructions.

== Constraints

* If you have added custom indexes to certain tables in the Engine database, you must remove them before updating to a later version. If you do not remove these indexes, the update process will not be complete.
* There is no guarantee that the Look & Feel definition is compatible across maintenance versions.
For example, in 6.2.2, `jquery+` was renamed `jqueryplus` in `BonitaConsole.html`, for compatibility with more application servers.
If you are using a custom Look & Feel,  xref:managing-look-feel.adoc[export] it before updating.
Then after the update process is complete,  xref:managing-look-feel.adoc[export the default Look & Feel] from the new version,
modify your custom Look & Feel to be compatible with the new definition, and with the  xref:creating-a-new-look-feel.adoc[recommendations for form footers].
Then  xref:managing-look-feel.adoc[import] your updated custom Look & Feel into Bonita Portal.
* The update script supports MySQL, Postgres, Oracle, and Microsoft SQL Server. There is no migration for h2 database.

[WARNING]
====

*Important:* +
The update operation resets the Bonita configuration files to default version for new settings to be applied (from the _$BONITA_HOME_ folder in <7.3.0 version or inside database in >=7.3.0).
Therefore, you must do a  xref:bonita-bpm-platform-setup.adoc#update_platform_conf[backup of your configuration files] before starting the update. +
You will need to merge custom properties and configurations to the updated environment.

Furthermore, from the database point of view, as any operations on a production system, updating is not a zero risk operation. +
Therefore, it is strongly recommended to do a  xref:back-up-bonita-bpm-platform.adoc[backup of your database] before starting the update process.
====

== Estimate time required

The platform must be shut down during update.
The time required depends on several factors including the database volume, the number of versions between the source version and the
target version, and the system configuration,
so it is not possible to be precise about the time that will be required. However, the following example can be used as a guide:

|===
|  |

| Database entries:
| data: 22541  +
flownode: 22482 +
process: 7493 +
connector: 7486 +
document: 7476

| Source version:
| 6.0.2

| Target version:
| 6.3.0

| Time required:
| 2.5 minutes
|===

[#migrate]

== Updating Bonita bundle: step-by-step procedure

This section explains how to update a platform that uses one of the Bonita bundles.

. Download the target version bundle and the Bonita Migration Tool for your Edition from the http://www.bonitasoft.com/downloads-v2[Bonitasoft site] for Bonita Community edition
or from the  https://customer.bonitasoft.com/download/request[Customer Service Center] for Bonita Subscription Pack editions.
. Check your current RDBMS version is compliant with the versions supported by the target version of Bonita (see  <<rdbms_requirements,above>>)
. Unzip the Bonita Migration Tool zip file into a directory. In the steps below, this directory is called `bonita-migration`.
. If you use Oracle, there is already the driver for 19.3.0.0 oracle version in the `bonita-migration/lib`. add the JDBC driver for your database to `bonita-migration/lib`. This is the same driver as you have installed in your web server `lib` directory. You must upgrade to  xref:migrate-from-an-earlier-version-of-bonita-bpm.adoc#oracle12[Oracle 12c (12.2.x.y)] in order to update to 7.9+.

WARNING: make sure you double check that you use the official driver version that match your Database version. The correct driver is mandatory for a smooth migration:  xref:database-configuration.adoc#proprietary_jdbc_drivers[Follow instructions for Oracle driver download.]
Particularly, if you use Oracle 12.2.0.x.y and are migrating to 7.9.n or to 7.10.n, then remove the existing `ojdbc8-19.3.0.0.jar` file, and add the specific JDBC driver to `bonita-migration/lib`.

. If you use Microsoft SQL Server, add the JDBC driver for your database type to `bonita-migration/lib`. This is the same driver as you have installed in your web server `lib` directory.
. Configure the database properties needed by the update script, by editing `bonita-migration/Config.properties`.
Specify the following information:
+
|===
| Property | Description | Example

| bonita.home
| The location of the existing bonita_home. Required only until 7.3
| `/opt/BPMN/bonita` (Linux) or `C:\\BPMN\\bonita` (Windows)

| db.vendor
| The database vendor
| postgres

| db.driverClass
| The driver used to access the database
| org.postgresql.Driver

| db.url
| The location of the Bonita Engine database
| `jdbc:postgresql://localhost:5432/bonita_migration`

| db.user
| The username used to authenticate to the database
| bonita

| db.password
| The password used to authenticate to the database
| bpm
|===

[NOTE]
====

Note: If you are using MySQL, add `?allowMultiQueries=true` to the URL. For example,
   `db.url=jdbc:mysql://localhost:3306/bonita_migration?allowMultiQueries=true`. +
   Also, if you are updating to Bonita 7.9+, you must upgrade your database server to MySQL 8.0, see <<mysql8,Updating to Bonita 7.9+ using MySQL>> specific procedure below.
====

. If you use a custom Look & Feel, xref:managing-look-feel.adoc[export] it, and then xref:managing-look-feel.adoc[restore the default Look & Feel].
. If you use a Business data model that requires to be redeployed (see  <<bdm_redeploy,above>>), you can pause the tenant so that as a tenant admin, you'll be able to redeploy the BDM on a paused tenant once update process is done.

[WARNING]
====

*IMPORTANT:* Do *not* xref:pause-and-resume-bpm-services.adoc[pause the BPM services] before you stop the application server. It will cause problems.
====

. Stop the application server.
. *IMPORTANT:*
   xref:back-up-bonita-bpm-platform.adoc[Back up your platform] and database in case of problems during update.
. Go to the directory containing the Bonita Migration Tool.
. Run the appropriate update script:
|===
|*Version* |*Edition* |*Script*
|Bonita Migration Tool 1.x
|
a|
* migration.sh 
* migration.bat (Windows)
|Bonita Migration Tool 2.x
|Community edition
a|
* bonita-migration-distrib (Linux) 
* bonita-migration-distrib.bat (Windows)
|Bonita Migration Tool 2.x
|Subscription editions
a|
* bonita-migration-distrib-sp (Linux)
* bonita-migration-distrib-sp.bat (Windows)
|===

 ** Starting from version 2.44.1, an additional script called `check-migration-dryrun` is present in the same folder. It can be used as a *pre-update check* as it does all the verification without actually updating the elements.This is equivalent to running the migration script with a `--verify` option.
. The script detects the current version of Bonita, and displays a list of the versions that you can update to. Specify the
version you require.
The script starts the update process.
. All along script's execution you will be informed of the advancement level with user messages, that you will be asked to confirm for proceeding to the next step. The messages contain important information and we strongly advice you to keep a foreground execution. In case you prefer a background execution without user messages, set to “true” ` (-Dauto.accept=true)` system property.

At the end of the update script execution the new Runtime version, the database update, the time taken for updating all the elements will be mentioned in a dedicated user message. 

WARNING: Do not use the old application server: a new one needs to be installed with the Bonita binaries that match the target version.

. Unzip the target bundle version into a directory. In the steps below, this directory is called `bonita-target-version`.
. xref:database-configuration.adoc[Configure the bundle to use the migrated database].

 Do not recreate the database and use the setup tool of the `bonita-target-version` Edit the `bonita-target-version/setup/database.properties` file to point to the migrated database.

. Reapply configuration made to the platform, using the setup tool of the `bonita-target-version`
+
Download the configuration from database to the local disk.
+
There is below a Linux example:
+
[source,bash]
----
cd setup
./setup.sh pull
----
+
You must reapply the configuration that had been done on the original instance's BONITA_HOME into the `bonita-target-version/setup/platform_conf/current`    ````
+
Please refer to the guide on updating the configuration file using the  xref:bonita-bpm-platform-setup.adoc#update_platform_conf[platform setup tool]
+
When done, push the updated configuration into the database:
+
[source,bash]
----
./setup.sh push
----

. If you have done specific configuration and customization in your server original version, re-do it by configuring the application server at `bonita-target-version/server` (or `bonita-target-version` if target version is 7.3.n): customization, libs etc.
. *If your Bonita version is 7.4 or above before updating, you can skip this point.* +++<a id="compound-permission-migration">++++++</a>+++
In the case where deployed resources have required dedicated  xref:resource-management.adoc#permissions[authorizations to use the REST API], these authorizations are not automatically updated.
Some manual operations have to be done on files that are  located in the extracted `platform_conf/current` folder (see  xref:bonita-bpm-platform-setup.adoc#update_platform_conf[Update Bonita Platform configuration] for more information). You need to:
 ** Perform a difference check between the versions before and after update of `tenants/[TENANT_ID]/conf/compound-permissions-mapping.properties` and put the additional lines into the file `tenants/[TENANT_ID]/conf/compound-permissions-mapping-custom.properties`
 ** Perform a difference check between the versions before and after update of `tenants/[TENANT_ID]/conf/resources-permissions-mapping.properties` and put the additional lines into the file `tenants/[TENANT_ID]/conf/resources-permissions-mapping-custom.properties`
 ** Perform a difference check between the versions before and after update of `tenants/[TENANT_ID]/conf/dynamic-permissions-checks.properties` and put the additional lines into the file `tenants/[TENANT_ID]/conf/dynamic-permissions-checks-custom.properties`
 ** Report all the content of the version before update of``tenants/[TENANT_ID]/conf/custom-permissions-mapping.properties`` into the new version.
. Configure License:
+
you need to put a new license in the database: see  xref:bonita-bpm-platform-setup.adoc#update_platform_conf[Platform configuration] for further details.
There is below a Linux example:
+
[source,bash]
----
cd setup
vi database.properties
./setup.sh pull
ls -l ./platform_conf/licenses/
----
+
If there is no valid license in the `./platform_conf/licenses/`, these 2 pages will help you to request and install a new one:

 ** https://documentation.bonitasoft.com/?page=licenses[Licenses]
 ** xref:bonita-bpm-platform-setup.adoc#update_platform_conf[Platform configuration]

+
Install the new license:
+
[source,bash]
----
cp BonitaSubscription-7.n-Jerome-myHosname-20171023-20180122.lic ./platform_conf/licenses/
./setup.sh push
----

. Start the application server. Before you start Bonita Portal, clear your browser cache. If you do not clear the cache, you might see old, cached versions of Portal pages instead of the new version.
Log in to the Portal and verify that the update process has completed.
If you did not set the default Look & Feel before update and you cannot log in, you need to  xref:managing-look-feel.adoc[restore the default Look & Feel] using a REST client or the Engine API.
. *If you update to a later version than 7.7*
In that case, if you used the Bonita Migration Tool 2.41.1 or greater, the table `arch_contract_data` is automatically backed up to the table `arch_contract_data_backup` to avoid long lasting update.
To reintegrate the data into your installation, a new tool is provided in versions 2.46.0 and above. It is located in the `tools/live-migration` folder.
Follow instruction in the README.md to run this tool and re-integrate data from `arch_contract_data_backup`.

The update is now complete. If you were using a custom Look & Feel before updating, test it on the new version before applying it to your updated platform.

== Updating processes with 6.x forms and case overview pages

Until Bonita 7.0.0, Bonita used UI artifacts based on the Google Web Toolkit (GWT) technology: process instantiation forms, task execution forms and case overview page. The runtime support for those forms and pages was removed in 7.8.0.

It means that if one or more processes on the target server uses 6.x forms or overview page, the migration to a Bonita 7.7.x and greater cannot be performed directly. The following lines explain how to migrate a process to Bonita 7.8.0, for example.

WARNING: The disabled processes with 6.x forms cannot be enabled again post update.

|===
| From a Bonita *6.x version* | From a Bonita *7.x version*
a|
. Update to Bonita 7.0.0 using the Migration Tool 1.x.
. Update to the last 7.7.x version, using the Migration Tool 2.x.
. Redesign your processes to use contracts at process instantiation and task execution levels, and recreate all your forms and case overview pages in Bonita Studio using the UI Designer or your favorite IDE, so that they use xref:contracts-and-contexts.adoc[contracts]. For more information, go to xref:migrate-a-form-from-6-x.adoc[migrate a form from 6.x]
. Upload the new version of all your processes using contracts, new forms, and new case overview pages.
. Make sure the versions of the processes using 6.x forms have no more running instances, and disable them.
. Perform the updating procedure to the desired version.
a|
. Redesign all your forms in Bonita Studio using the UI Designer. For more information, see xref:migrate-a-form-from-6-x.adoc[how to migrate a form from 6.x]
. Upload the new versions of all your processes using the new forms
. Make sure the versions of your processes using 6.x forms have no more running instances
. Disable them
. Perform the updating procedure to the desired version
|===

Having 6.x case overview pages on your processes will not prevent updating the platform,
however they will all be replaced by the default 7.x case overview page, created with the UI Designer.
It means that you might want to redo the case overview page as well as the forms, especially if you have configured
a custom case overview page for your processes in version 6.x. Or (for Enterprise, Performance, and Efficiency editions only),
you can live update it after update.

[NOTE]
====

Note: 6.x application resources have been removed too in 7.8.0, so if you are migrating a process that leverage this feature, you need to modify it (for example to use process dependencies instead (Configure > Process dependencies in Bonita Studio)).
====

[#update-case-overview-pages]

== Use the provided Bonita tool to update case overview pages before updating to 7.8.0

Bonita Migration Tool now ships an option to allow you to replace 6.x case overview pages with the default 7.x case overview page
(created with the UI Designer), when your Bonita runtime is still in a pre-7.8.0 version. This allows you to see if the page suits your needs, or if not,
it can be used as a base to customize your case overview page. Your pages will then be ready for the 7.8.0 update step.

To run it, unzip the latest Bonita Migration Tool and run, for *Community* edition: +
`./bonita-migration-distrib` (Linux) or `bonita-migration-distrib.bat` (Windows) `--updateCaseOverview <PROCESS_DEFINITION_ID>`

or for *Subscription* edition: +
`./bonita-migration-distrib-sp` (Linux) or `bonita-migration-distrib-sp.bat` (Windows) `--updateCaseOverview <PROCESS_DEFINITION_ID>`

For instance:

[source,bash]
----
./bonita-migration-distrib-sp --updateCaseOverview 6437638294854549375
----

If you want to update several processes, simply run the command with all the processDefinitionId's one by one.

[NOTE]
====

Note: This tool will only change case overview pages. This means that if some of your processes still have process instantiation / task execution forms,
you need to redesign them in the Studio using Bonita UI designer, as explained in the section above.
====

Example of output issued when running the tool:
++++
<asciinema-player src="_images/images/case_overview_update_mode-ascii.cast" speed="2" theme="monokai" title="Update case overview console output example" cols="240" rows="32"></asciinema-player>
++++


== Updating to Java 11 in Bonita 7.9

Bonita 7.9+ supports Java 11.
Updating an existing platform to Java 11 is not an easy, or painless endeavour.
To update a Bonita platform to Java 11, you need to follow the following steps:

* Update the platform to Bonita 7.9.0 as usual, and keep running it in Java 8. Verify that everything works as expected.
* Test the updated platform in Java 11, on a test environment.
* Once tested, update what is required on the production server, and switch it to Java 11.

The main parts that require attention and testing are connectors and custom code:

The 7.9.0 update step tries its best to update the implementation of connectors that are known *not to* work in Java 11, namely WebService, CMIS, Email and Twitter. +
See xref:_connector_details_regarding_migration_to_7_9[].

On the other hand, custom connectors, groovy scripts, rest api extensions etc. are not updated and might not work outright in Java 11.

Aside from just code incompatibility, special attention has to be given to the dependencies of the custom code, as they might either not work in Java 11, work fine but conflict with Bonita own dependencies or the script might use dependencies previously included in Bonita, but no more accessible, or accessible in a different version. +
Thus, thorough tests have to be carried out so ensure there is no regression when updating Bonita to version 7.9+.

[#postgres11]

== Updating to Bonita 7.9+ using PostgreSQL

Bonita 7.9+ supports PostgreSQL 11.x (x>=2) which is not compatible with previous versions.
When updating to Bonita 7.9+ using PostgreSQL follow this procedure:

* shutdown Bonita
* Run Bonita Migration Tool to the latest Bonita version supporting postgres 9 (7.8.4)
* Backup the Bonita database
* Migrate PostgreSQL from 9 to 11.x (x>=2) following the [Official documentation]
(https://www.postgresql.org/docs/11/upgrading.html)
* Run again the Bonita Migration Tool to the desired Bonita version requiring PostgreSQL 11
* Restart your updated Bonita platform

[#mysql8]

== Updating to Bonita 7.9+ using MySQL

Bonita 7.9+ supports MySQL 8.0.x version, which is not compatible with older versions of MySQL. For this reason, to update to Bonita 7.9+ when using MySQL,
please follow this procedure:

* ensure your Bonita platform is shut down
* run Bonita Migration Tool to update Bonita platform to version 7.9 or newer, following the procedure above
* upgrade your MySQL database server installation following the  https://dev.mysql.com/doc/refman/8.0/en/upgrading.html[official documentation]
* once done, you can restart your updated Bonita platform

[#oracle12]

== Update to Bonita 7.9+ using Oracle

Bonita 7.9+ supports Oracle 12c (12.2.0.x.y) and Oracle 19c (19.3.0.0) versions: this is a requirement change.

The Oracle database server change needs to be done before using the Bonita Migration Tool from 7.8.4 to 7.9.0.

=== Update to 7.8.4

Skip this section and jump directly to *Upgrade Oracle database server* section if the 7.8.4 is already the version in use.

* shut down the Bonita platform
* run Bonita Migration Tool to update Bonita platform to version 7.8.4, following the update procedure <<migrate,above>>

=== Upgrade Oracle database server

* shut down the Bonita platform
* upgrade the Oracle database server to the version 12c (it must be 12.2.0.x.y) or 19c (it must be 19.3.0.0)

=== Configure the Oracle database server

* configure the Oracle database server, in particular activate the XA transactions management: see the _Oracle Database_ section in the xref:database-configuration.adoc[Database creation and configuration for Bonita engine and BDM] page
* install the missing Oracle components
* execute the SQL scripts to _install_ XA management elements
* execute the SQL requests to GRANT the proper rights to the Oracle users; for both Bonita BPM and BDM schemas

=== Download the specific jdbc driver for the Oracle 12c (12.2.0.x.y) or 19c (19.3.0.0)

*Beware*: two different jdbc driver jar files may share the same name (ojdbc8.jar).

Each file however is specific to the Oracle DB server version installed.
Please make sure to download the appropriate one:

* Oracle 12c (12.2.0.x.y) : Driver ojdbc8.jar https://www.oracle.com/database/technologies/jdbc-ucp-122-downloads.html[Oracle Database 12.2.0.1 JDBC Driver & UCP Downloads] ( make sure it is the official driver by checking the SHA1 Checksum: 60f439fd01536508df32658d0a416c49ac6f07fb )
* Oracle 19c (19.3.0.0) : Driver ojdbc8.jar https://www.oracle.com/database/technologies/appdev/jdbc-ucp-19c-downloads.html[Oracle Database 19c (19.3) JDBC Driver & UCP Downloads] ( make sure it is the official driver by checking the SHA1 Checksum: 967c0b1a2d5b1435324de34a9b8018d294f8f47b )

*Note I*: The Bonita Migration Tool already includes the oracle driver for Oracle 19c (19.3.0.0) in the `bonita-migration/lib` directory. If your are not using Oracle 19c (19.3.0.0) you need to replace it.

=== Check the Bonita 7.8.4 server starts with the Oracle database server 12c (12.2.0.x.y) or 19c (19.3.0.0)

* download and install a Bonita 7.8.4 server
* setup the Bonita 7.8.4 server to use the Oracle 12c (12.2.0.x.y) or 19c (19.3.0.0) database
* request and install a temporary 7.8 license in the Bonita server
* start the Bonita 7.8.4 server
* check you can successfully log into the portal

=== Update to 7.9+

* shut down the Bonita platform
* run the Bonita Migration <tool to update the platform to 7.9+, following the update procedure <<migrate,above>>
* then upgrade your Oracle database server to the version 12c (it must be 12.2.x.y)
* in a second step, run the Bonita Migration Tool again to update the platform to 7.9.0 or newer
* once done, you can restart your updated Bonita platform

== Update your cluster

A Bonita cluster must have the same version of Bonita on all nodes. To update a cluster:

. Download the Bonita Migration Tool:
 ** If you use Bonita Migration Tool 1.x you must download the tool for Performance cluster, the ordinary Performance migration tool does not support cluster update.
 ** Otherwise, use Bonita Migration Tool 2.x.
. Shutdown all cluster nodes.
. On one node, follow the procedure above to update the platform.
. When the migration is complete on one node, follow steps 12 to 16 on all the other nodes.

Cluster update process is now complete, and the cluster can be restarted.

== Migrate your client applications

If you have applications that are client of Bonita, you may have to change your client code or library. Most of the
time, we guarantee backward compatibility. In any cases, please read the  xref:release-notes.adoc[release notes] to check if
some changes have been introduced.

In addition, if your application connect to the Bonita Engine using the HTTP access mode, see the xref:configure-client-of-bonita-bpm-engine.adoc[bonita-client library]
documentation page.

== Troubleshooting

=== Timers are stuck after updating to 7.10.0+

_Symptom_: When updating to 7.10.0+ the timers on processes don't work anymore.

_Cause_: Bug in the pause/resume of tenant services, fixed in 7.12.1 version.
This issue happens because the xref:pause-and-resume-bpm-services.adoc[BPM services] were paused before the update was performed.

_Solution_: If the BPM services were paused before updating or had to be paused for whatever reason, then to resolve this,
you need to execute the following database requests after the update process completes and before you restart your Bonita platform:

----
DELETE FROM QRTZ_PAUSED_TRIGGER_GRPS;
UPDATE QRTZ_TRIGGERS SET TRIGGER_STATE = 'WAITING' WHERE TRIGGER_STATE = 'PAUSED';
----

After this operation, the table QRTZ_PAUSED_TRIGGER_GRPS should be empty, and all the triggers in the QRTZ_TRIGGERS table should be in state _waiting_, and not _paused_.


== Addendum

=== Connector details regarding update to 7.9

For Bonita 7.9.0, the update step tries to migrate the _CMIS_, _Email_ and _Webservice_ connectors of the processes deployed on the platform, along with their dependencies, to allow the updated platform to run on Java 11. +
The step works at best effort:

* It will try to upgrade all the connectors it can.
* It will not upgrade connectors that have dependencies used by other connectors. Those connectors will still work on java 8, but not in java 11, and will require a manual update.
* A detailed report of all the changes made is displayed at the end of the update step.
* Beware that if one of these connectors' removed dependencies was used in one your scripts, it will still be removed/updated, and therefore your scripts might not work anymore after update. The full list of updated and deleted dependencies can be found below.

From Bonita 7.9+, the supported version of Oracle database is *12c (12.2.x.y)*
To update to Bonita 7.9+ from an earlier version than Oracle 12c (12.2.x.y), see xref:migrate-from-an-earlier-version-of-bonita-bpm.adoc#oracle12[Updating to Bonita 7.9+ using Oracle].

==== WebService connector

The following dependencies have been added, to ensure Java 11 compliance:

* _javax.xml.stream:stax-api:1.0-2_
* _org.codehaus.woodstox:woodstox-core-asl:4.1.2_
* _org.codehaus.woodstox:stax2-api:3.1.1_
* _com.sun.istack:istack-commons-runtime:2.4_
* _javax.activation:activation:1.1_
* _com.sun.xml.messaging.saaj:saaj-impl:1.3.28_
* _javax.xml.ws:jaxws-api:2.2.7_
* _com.sun.xml.ws:jaxws-rt:2.2.7_
* _javax.jws:jsr181-api:1.0-MR1_
* _javax.xml.bind:jaxb-api_
* _com.sun.xml.bind:jaxb-impl_

==== CMIS connector

The following dependencies were updated to ensure Java 11 compliance:

* _org.apache.chemistry.opencmis:chemistry-opencmis-client-impl_ dependency has been updated from _0.13.0_ to _1.1.0_
* _org.apache.chemistry.opencmis:chemistry-opencmis-client-api_ dependency has been updated from _0.13.0_ to _1.1.0_
* _org.apache.chemistry.opencmis:chemistry-opencmis-commons-api_ dependency has been updated from _0.11.0_ to _1.1.0_
* _org.apache.chemistry.opencmis:chemistry-opencmis-commons-impl_ dependency has been updated from _0.11.0_ to _1.1.0_
* _org.apache.chemistry.opencmis:chemistry-opencmis-client-bindings_ dependency has been updated from _0.11.0_ to _1.1.0_
* _org.apache.cxf:cxf-rt-bindings-xml_ dependency has been updated from _2.7.7_ to _3.0.12_
* _org.apache.cxf:cxf-rt-frontend-simple_ dependency has been updated from _2.7.7_ to _3.0.12_
* _org.apache.cxf:cxf-rt-core dependency_ dependency has been updated from _2.7.7_ to _3.0.12_
* _org.apache.cxf:cxf-rt-transports-http_ dependency has been updated from _2.7.7_ to _3.0.12_
* _org.apache.cxf:cxf-rt-ws-policy_ dependency has been updated from _2.7.7_ to _3.0.12_
* _org.apache.cxf:cxf-rt-ws-addr_ dependency has been updated from _2.7.7_ to _3.0.12_
* _org.apache.cxf:cxf-rt-bindings-soap_ dependency has been updated from _2.7.7_ to _3.0.12_
* _org.apache.cxf:cxf-rt-databinding-jaxb_ dependency has been updated from _2.7.7_ to _3.0.12_
* _org.apache.cxf:cxf-rt-frontend-jaxws_ dependency has been updated from _2.7.7_ to _3.0.12_
* _org.apache.neethi:neethi_ dependency has been updated from _3.0.2_ to _3.0.3_
* _org.apache.ws.xmlschema:xmlschema-core_ dependency has been updated from _2.0.3_ to _2.2.1_

The following dependencies have been added to ensure Java 11 compliance:

* _org.apache.cxf:cxf-rt-wsdl-3.0.12_

The following dependencies have been removed:

* _org.jvnet.mimepull:mimepull-1.9.4.jar_
* _org.codehaus.woodstox:stax2-api-3.1.1.jar_
* _org.apache.geronimo.javamail:geronimo-javamail_1.4_spec-1.7.1.jar_
* _org.codehaus.woodstox:woodstox-core-asl-4.2.0.jar_
* _org.apache.cxf:cxf-api-2.7.7.jar_

In addition _bonita-connector-cmis-+++<specific Implementation="">+++.jar_ and _bonita-connector-cmis-common-+++<version>+++.jar_ have been replaced by a single bonita-connector-cmis-+++<version>+++.jar+++</version>++++++</version>++++++</specific>+++

==== Email connector

The version of the _javax.mail:mail_ dependency has been updated from _1.4.5_ to _1.4.7_

==== Twitter connector

The version of the _org.twitter4j:twitter4j-core_ dependency has been updated from _4.0.2_ to _4.0.7_
